name: WireGuard over Ngrok

on:
  workflow_dispatch:

jobs:
  tunnel:
    runs-on: ubuntu-latest
    steps:

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y wireguard curl

    - name: Generate WireGuard keys
      run: |
        mkdir wg
        cd wg
        umask 077
        wg genkey | tee privatekey | wg pubkey > publickey

    - name: Create WireGuard config
      run: |
        PRIV_KEY=$(cat wg/privatekey)
        cat <<EOF > wg/wg0.conf
        [Interface]
        Address = 10.0.0.1/24
        PrivateKey = $PRIV_KEY
        ListenPort = 51820
        EOF

    - name: Show Server Public Key
      run: cat wg/publickey

    - name: Start WireGuard
      run: sudo wg-quick up wg/wg0.conf

    - name: Download Ngrok
      run: |
        curl -sLo ngrok.zip https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
        unzip ngrok.zip
        chmod +x ngrok

    - name: Start Ngrok TCP Tunnel on 51820
      run: |
        ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        nohup ./ngrok tcp 51820 > ngrok.log &
        sleep 5
        cat ngrok.log | grep -o 'tcp://[0-9a-zA-Z.:]*'

    - name: Show Public Key & Tunnel Info
      run: |
        echo "=== WireGuard Public Key ==="
        cat wg/publickey
        echo "=== Ngrok Tunnel URL ==="
        curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[0-9a-zA-Z.:]*'

    - name: Keep Alive
      run: sleep 86400
