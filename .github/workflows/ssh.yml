name: Ubuntu XFCE4 + noVNC + Ngrok

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-24.04

    steps:
    - name: Update & Install Packages
      run: |
        sudo apt-get update -y
        sudo apt-get install -y x11vnc xvfb \
          websockify novnc net-tools wget curl unzip jq \
         neofetch

    - name: Setup Virtual Display + XFCE4
      run: |
        export DISPLAY=:1
        Xvfb :1 -screen 0 1366x768x16 &
        sleep 3
        startxfce4 &

    - name: Setup VNC + noVNC
      run: |
        x11vnc -forever -usepw -create -display :1 -passwd github &
        websockify --web=/usr/share/novnc 6080 localhost:5900 &

    - name: Download ngrok
      run: |
        wget -q -O ngrok.zip https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
        unzip ngrok.zip
        chmod +x ./ngrok

    - name: Start Ngrok Tunnel
      run: |
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        nohup ./ngrok http 6080 > ngrok.log 2>&1 &
        sleep 5

    - name: Show Ngrok URL
      run: |
        curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url'

    - name: Keep Alive
      run: |
        echo "ðŸ”¥ XFCE4 + noVNC started. Access via Ngrok URL above."
        while true; do sleep 30; done
